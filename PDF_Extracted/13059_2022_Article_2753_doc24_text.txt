# Ma et al. Genome Biology (2022) 23:208

# Association analyses

# Omnibus testing of microbial composition associations

We used PERMANOVA tests (2000 permutations) as implemented in the R package vegan [38] using Bray-Curtis dissimilarities for all omnibus association tests of overall microbial community structure with covariates (Fig. 3a). Where appropriate, R2s were calculated conditioning on the necessary covariates; specifically, CD/UC Montreal classifications were conditional on CD/UC samples respectively, treatment was conditional on IBD status, biopsy location was conditional on a sample being a biopsy, and all covariates were conditional on being non-missing. Otherwise, variables were tested marginally (that is, each as the sole variable in the model). Importantly, to account for repeated measures within subjects for longitudinal studies, we adopted the blocked permutation strategy as in [9], where per-sample measurements (sample type, biopsy location, treatment) were permuted within subjects, and per-subject measurements (disease, demographics) were permuted along with subjects (but within cohorts, relevant for the all-cohort evaluation). For a full list of the model and permutation strategies that this resulted in for our analysis, please refer to Additional file 5: Table S3. Finally, per-variable p-values were adjusted with Benjamini-Hochberg false discovery rate control on a per-study basis.

# Per‑feature meta‑analysis differential abundance testing

To identify microbial features individually significantly associated with one or more covariates, we applied MMUPHin’s differential abundance testing model (MMUPHin_MetaDA) as described above. Cohorts were first stratified by sample type (biopsy or stool) and, where appropriate, diseases (CD or UC) prior to model fitting. Arcsin square root-transformed genus level taxon abundances were tested for covariate associations in individual cohort strata with multivariate linear modelling (linear random intercept model adopted for longitudinal studies). Covariates used for adjustment include age, gender, and race for disease variables, and additionally disease status for treatment variables. Effect sizes across cohort strata were aggregated with a random effects model with restricted maximum likelihood estimation [34]. P-values were FDR adjusted across features for each variable. For the full list of models adopted as well as cohort stratification strategy, please refer to Additional file 5: Table S3. Figure 3b visualizes the aggregated meta-analysis effects; for individual study results, refer to Additional file 6: Table S4.

To relate these real data results to our simulation evaluation, the real-world data characteristics best correspond with the simulated scenario with eight batches and four thousand samples in total (versus ten real studies and 4789 samples post filtering), 200 microbial features (249 real genera), and 10% spiked features at batch effect size 10, which yielded ~10% PERMANOVA R2 for batch effect and 3% R2 for binary exposure.