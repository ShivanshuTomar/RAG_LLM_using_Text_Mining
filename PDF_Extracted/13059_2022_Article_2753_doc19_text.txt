# Evaluating batch adjustment

For evaluation of MMUPHin’s batch effect adjustment component, MMUPHin_Correct, we simulated metadata that included batch (with varying total batch numbers 2, 4, 6, 8), a binary positive control (simulated “biological” covariate), continuous positive control (“biological”), and negative control (binary, and guaranteed to be non-associated with microbial features) variables. Microbial abundance data was simulated to be associated with the batch and the two positive control variables at varying effect sizes (1, 2, 5, 10 for batch variable and fixed at 10 for positive control variables), but not with the negative control variable. We additionally varied the number of samples per batch (20 to simulate multiple-batches in a single study scenario, 100 to simulate meta-analysis with moderate sized studies and 500 to simulate large meta-analysis), total number of microbial features (n=200 and 1000), as well as the percentage of features associated with metadata (5%, 10%, and 20%) (Additional file 4: Table S2).

Performance of batch correction methods was quantified by omnibus associations (PERMANOVA R2) between the simulated microbial abundance data with the batch and positive control variables, before and after batch correction. For ComBat [15] and our method, batch correction was performed with both positive control variables and the negative control variable as covariates. MMUPHin_Correct successfully reduced the confounding batch effect, but retained the effect of positive control variables, and did not inflate the effect of negative control variable (Fig. 2a, Additional file 1: Fig. S6).

# Evaluating meta‑analytic differential abundance testing

We evaluated false positive rates (FPR) for meta-analytic feature association testing, specifically the null case in which there are no associations between microbial features and covariates, but false associations can arise in the presence of batch effects with unbalanced distribution of covariate values across studies (Fig. 2b). For simulation, we generated a binary covariate unevenly distributed between two “studies” at varying levels of disparity (Additional file 4: Table S2). Microbial abundance data was simulated to be associated only with the two studies and not with the covariate (i.e., study confounded null data), with varying strengths of batch effect (from 0 to 10). The number of samples per batch varied between 100 and 500 to, again, simulate moderate- and large-sized meta-analysis. Lastly, we varied a total number of microbial features and the percentage of features associated with metadata as above.

FPRs were calculated as the percentage of simulated microbial features with nominal p-values < 0.05 for associations with the exposure variable. Four data normalization and analysis regimes were evaluated (Fig. 2c, Additional file 1: Fig. S6): (a) naive MaAs-Lin2 model on the study effect confounded null data (without explicitly modelling the batches), (b) the quantile normalization procedure, paired with two-tailed Wilcoxon tests, as proposed in [18], (c) BDMMA as proposed in [19], with the default 10,000 total MCMC sampling and 5000 burn-in, (d) the complete MMUPHin meta-analysis model for the batch-corrected data as described above (MMUPHin_Correct + MMUPHin_MetaDA). Note that due to its computational cost we were only able to evaluate the Dirichlet-multinomial regression model on a subset of parameter combinations, namely number of samples per batch = 100, number of features = 200, and percent of associated.